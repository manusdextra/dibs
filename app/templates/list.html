{% extends "base.html" %}
{% from "form.html" import formbase %}

{% block title %}dibs - {{ currentlist.title }}{% endblock %}
{% block head %} {{ super() }} {% endblock %} 
{% block page_content %}
<main class="container">
  <hgroup>
    <h1>
      {{ currentlist.title }}
    </h1>
    <h2>by <a href="{{ url_for("main.profile", username=currentlist.author.username) }}">{{ currentlist.author.username }}</a></h2>
  </hgroup>

  <section>
  {% if items %}
    {% for category in categories %}
    <h4>{{ category.name }}</h4>
    <hr />
    <ul>
      {% for item in items %}
      {% if item.category_id == category.id %}
        <li>
          <div>
            {% if item.link %}
            <a href="https://{{ item.link|safe }}">{{ item.name }}</a>
            {% else %}
            {{ item.name }}
            {% endif %}

            {% if current_user.id != currentlist.author.id %}
                {% if comments %}
              <ul>
                {% for comment in comments %}
                {% if comment.item_id == item.id %}
                  <blockquote>{{ comment.body }}<footer><cite>â€”{{ comment.author | capitalize }}</cite></footer></blockquote>
                  
                {% endif %}
                {% endfor %}
              </ul>
                {% endif %}
            <details>
              <summary>Add a Comment </summary>
                {% set action = url_for('main.add_comment', list_id=currentlist.id, item_id=item.id) %}
                  {{ formbase(commentform, action=action) }}
                  {#
                  <a href="{{ url_for("main.add_comment", list_id=currentlist.id, item_id=item.id) }}">Add a comment</a>
                  #}
            </details>
            {% endif %}
          </div>
          {% if item.description %}<div> {{ item.description }} </div>{% endif %}

            {% if current_user.role_id == 2 %}
            <a href="{{ url_for(
              "main.delete_item",
              list_id=currentlist.id,
              item_id=item.id
              )}}">
              [ delete? ]</a>
            {% endif %}

        </li>
        {% endif %}
      {% endfor %}
    </ul>
    {% endfor %}
  {% else %}
  <p>
  This list is empty. {% if user == current_user %}Scroll down to add things to it.{% endif %}
  </p>
  {% endif %}
  </section>

  {# #}
  {% if user == current_user %}
  <section>
    <div>
      <h3>
      Add items
      </h3>
      {{ formbase(itemform) }}
    </div>
  </section>
  {% endif %}

  {% if current_user.is_administrator() %}
  <a href="{{url_for("main.delete_list", list_id=currentlist.id)}}">Delete this list</a>
  {% endif %}
</main>
{% endblock %}
